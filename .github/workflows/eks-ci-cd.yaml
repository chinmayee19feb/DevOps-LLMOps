name: EKS Restauranty CI/CD

on:
  push:
    branches: [ aws-eks-deployment ]
  workflow_dispatch:

env:
  AWS_REGION: us-east-2
  ECR_REGISTRY: 686699774218.dkr.ecr.us-east-2.amazonaws.com
  ECR_REPOSITORY: ecr-chinmayee
  EKS_CLUSTER_NAME: diogo-ft-cluster
  K8S_NAMESPACE: chinmayee

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [frontend, auth, discounts, items]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: 'aws-eks-deployment'

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      - name: Build and push Docker image
        run: |
          SHORT_SHA=${GITHUB_SHA:0:8}
          
          if [ "${{ matrix.service }}" == "frontend" ]; then
            BUILD_CONTEXT="./client"
            DOCKERFILE="./client/Dockerfile"
          elif [ "${{ matrix.service }}" == "auth" ]; then
            BUILD_CONTEXT="./backend/auth"
            DOCKERFILE="./backend/auth/Dockerfile"
          elif [ "${{ matrix.service }}" == "discounts" ]; then
            BUILD_CONTEXT="./backend/discounts"
            DOCKERFILE="./backend/discounts/Dockerfile"
          elif [ "${{ matrix.service }}" == "items" ]; then
            BUILD_CONTEXT="./backend/items"
            DOCKERFILE="./backend/items/Dockerfile"
          fi
          
          IMAGE_TAG="${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:restauranty-${{ matrix.service }}-$SHORT_SHA"
          
          echo "Building $IMAGE_TAG"
          
          docker build -t $IMAGE_TAG -f $DOCKERFILE $BUILD_CONTEXT
          docker push $IMAGE_TAG
          
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_ENV

      - name: Update Kubernetes manifests
        run: |
          SHORT_SHA=${GITHUB_SHA:0:8}
          IMAGE_TAG="${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:restauranty-${{ matrix.service }}-$SHORT_SHA"
          
          DEPLOYMENT_FILE="k8s/${{ matrix.service }}-deployment.yaml"
          
          if [ -f "$DEPLOYMENT_FILE" ]; then
            echo "Updating $DEPLOYMENT_FILE with image: $IMAGE_TAG"
            sed -i "s|image:.*${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:.*|image: $IMAGE_TAG|g" "$DEPLOYMENT_FILE"
            sed -i "s|image:.*restauranty-${{ matrix.service }}.*|image: $IMAGE_TAG|g" "$DEPLOYMENT_FILE"
          fi

  deploy-to-eks:
    runs-on: ubuntu-latest
    needs: build-and-push
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: 'aws-eks-deployment'

      - name: Download manifests
        uses: actions/download-artifact@v4
        with:
          name: k8s-manifests
          path: k8s-deploy

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Configure kubectl for EKS
        run: |
          aws eks update-kubeconfig \
            --region ${{ env.AWS_REGION }} \
            --name ${{ env.EKS_CLUSTER_NAME }}

      - name: Create namespace if not exists
        run: |
          kubectl create namespace ${{ env.K8S_NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy all resources
        run: |
          echo "Deploying to EKS"
          
          for file in k8s-deploy/*.yaml; do
            if [ -f "$file" ]; then
              echo "Applying: $(basename $file)"
              kubectl apply -f "$file" -n ${{ env.K8S_NAMESPACE }}
            fi
          done

      - name: Verify deployment
        run: |
          echo "=== Deployment Status ==="
          kubectl get deployments -n ${{ env.K8S_NAMESPACE }}
          
          echo ""
          echo "=== Pods Status ==="
          kubectl get pods -n ${{ env.K8S_NAMESPACE }}
          
          echo ""
          echo "=== Services Status ==="
          kubectl get services -n ${{ env.K8S_NAMESPACE }}

      - name: Wait for pods
        run: |
          echo "Waiting for pods..."
          sleep 30
          
          for i in {1..10}; do
            READY_PODS=$(kubectl get pods -n ${{ env.K8S_NAMESPACE }} --field-selector=status.phase=Running --no-headers 2>/dev/null | wc -l)
            TOTAL_PODS=$(kubectl get pods -n ${{ env.K8S_NAMESPACE }} --no-headers 2>/dev/null | wc -l)
            
            if [ $READY_PODS -eq $TOTAL_PODS ] && [ $TOTAL_PODS -ge 5 ]; then
              echo "âœ… All pods running!"
              break
            fi
            
            echo "Attempt $i: $READY_PODS/$TOTAL_PODS pods ready"
            sleep 10
          done